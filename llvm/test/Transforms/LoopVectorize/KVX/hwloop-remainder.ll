; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt -S -passes=loop-vectorize < %s | FileCheck %s

target triple = "kvx-kalray-cos"

define void @matrix_mul_const(i32 %0, ptr nocapture %1, ptr nocapture readonly %2, i16 %3) local_unnamed_addr #0 {
; CHECK-LABEL: @matrix_mul_const(
; CHECK-NEXT:    [[TMP5:%.*]] = icmp sgt i32 [[TMP0:%.*]], 0
; CHECK-NEXT:    br i1 [[TMP5]], label [[TMP6:%.*]], label [[TMP44:%.*]]
; CHECK:       6:
; CHECK-NEXT:    [[TMP7:%.*]] = sext i16 [[TMP3:%.*]] to i32
; CHECK-NEXT:    [[TMP8:%.*]] = sext i32 [[TMP0]] to i64
; CHECK-NEXT:    [[TMP9:%.*]] = zext i32 [[TMP0]] to i64
; CHECK-NEXT:    [[TMP10:%.*]] = add nsw i64 [[TMP9]], -1
; CHECK-NEXT:    [[TMP11:%.*]] = mul i64 [[TMP10]], [[TMP8]]
; CHECK-NEXT:    [[TMP12:%.*]] = shl i64 [[TMP11]], 2
; CHECK-NEXT:    [[TMP13:%.*]] = shl nuw nsw i64 [[TMP9]], 2
; CHECK-NEXT:    [[TMP14:%.*]] = add i64 [[TMP12]], [[TMP13]]
; CHECK-NEXT:    [[SCEVGEP:%.*]] = getelementptr i8, ptr [[TMP1:%.*]], i64 [[TMP14]]
; CHECK-NEXT:    [[TMP15:%.*]] = shl i64 [[TMP11]], 1
; CHECK-NEXT:    [[TMP16:%.*]] = shl nuw nsw i64 [[TMP9]], 1
; CHECK-NEXT:    [[TMP17:%.*]] = add i64 [[TMP15]], [[TMP16]]
; CHECK-NEXT:    [[SCEVGEP1:%.*]] = getelementptr i8, ptr [[TMP2:%.*]], i64 [[TMP17]]
; CHECK-NEXT:    br label [[TMP18:%.*]]
; CHECK:       18:
; CHECK-NEXT:    [[TMP19:%.*]] = phi i64 [ 0, [[TMP6]] ], [ [[TMP42:%.*]], [[TMP41:%.*]] ]
; CHECK-NEXT:    [[TMP20:%.*]] = mul nsw i64 [[TMP19]], [[TMP8]]
; CHECK-NEXT:    [[TMP21:%.*]] = zext i32 [[TMP0]] to i64
; CHECK-NEXT:    [[MIN_ITERS_CHECK:%.*]] = icmp ult i64 [[TMP9]], 16
; CHECK-NEXT:    br i1 [[MIN_ITERS_CHECK]], label [[SCALAR_PH:%.*]], label [[VECTOR_MEMCHECK:%.*]]
; CHECK:       vector.memcheck:
; CHECK-NEXT:    [[BOUND0:%.*]] = icmp ult ptr [[TMP1]], [[SCEVGEP1]]
; CHECK-NEXT:    [[BOUND1:%.*]] = icmp ult ptr [[TMP2]], [[SCEVGEP]]
; CHECK-NEXT:    [[FOUND_CONFLICT:%.*]] = and i1 [[BOUND0]], [[BOUND1]]
; CHECK-NEXT:    br i1 [[FOUND_CONFLICT]], label [[SCALAR_PH]], label [[VECTOR_PH:%.*]]
; CHECK:       vector.ph:
; CHECK-NEXT:    [[N_MOD_VF:%.*]] = urem i64 [[TMP9]], 16
; CHECK-NEXT:    [[N_VEC:%.*]] = sub i64 [[TMP9]], [[N_MOD_VF]]
; CHECK-NEXT:    [[BROADCAST_SPLATINSERT:%.*]] = insertelement <16 x i32> poison, i32 [[TMP7]], i64 0
; CHECK-NEXT:    [[BROADCAST_SPLAT:%.*]] = shufflevector <16 x i32> [[BROADCAST_SPLATINSERT]], <16 x i32> poison, <16 x i32> zeroinitializer
; CHECK-NEXT:    br label [[VECTOR_BODY:%.*]]
; CHECK:       vector.body:
; CHECK-NEXT:    [[INDEX:%.*]] = phi i64 [ 0, [[VECTOR_PH]] ], [ [[INDEX_NEXT:%.*]], [[VECTOR_BODY]] ]
; CHECK-NEXT:    [[TMP22:%.*]] = add i64 [[INDEX]], 0
; CHECK-NEXT:    [[TMP23:%.*]] = add nsw i64 [[TMP22]], [[TMP20]]
; CHECK-NEXT:    [[TMP24:%.*]] = getelementptr inbounds i16, ptr [[TMP2]], i64 [[TMP23]]
; CHECK-NEXT:    [[TMP25:%.*]] = getelementptr inbounds i16, ptr [[TMP24]], i32 0
; CHECK-NEXT:    [[WIDE_LOAD:%.*]] = load <16 x i16>, ptr [[TMP25]], align 2, !alias.scope [[META0:![0-9]+]]
; CHECK-NEXT:    [[TMP26:%.*]] = sext <16 x i16> [[WIDE_LOAD]] to <16 x i32>
; CHECK-NEXT:    [[TMP27:%.*]] = mul nsw <16 x i32> [[TMP26]], [[BROADCAST_SPLAT]]
; CHECK-NEXT:    [[TMP28:%.*]] = getelementptr inbounds i32, ptr [[TMP1]], i64 [[TMP23]]
; CHECK-NEXT:    [[TMP29:%.*]] = getelementptr inbounds i32, ptr [[TMP28]], i32 0
; CHECK-NEXT:    store <16 x i32> [[TMP27]], ptr [[TMP29]], align 4, !alias.scope [[META3:![0-9]+]], !noalias [[META0]]
; CHECK-NEXT:    [[INDEX_NEXT]] = add nuw i64 [[INDEX]], 16
; CHECK-NEXT:    [[TMP30:%.*]] = icmp eq i64 [[INDEX_NEXT]], [[N_VEC]]
; CHECK-NEXT:    br i1 [[TMP30]], label [[MIDDLE_BLOCK:%.*]], label [[VECTOR_BODY]], !llvm.loop [[LOOP5:![0-9]+]]
; CHECK:       middle.block:
; CHECK-NEXT:    [[CMP_N:%.*]] = icmp eq i64 [[TMP9]], [[N_VEC]]
; CHECK-NEXT:    br i1 [[CMP_N]], label [[TMP41]], label [[SCALAR_PH]]
; CHECK:       scalar.ph:
; CHECK-NEXT:    [[BC_RESUME_VAL:%.*]] = phi i64 [ [[N_VEC]], [[MIDDLE_BLOCK]] ], [ 0, [[TMP18]] ], [ 0, [[VECTOR_MEMCHECK]] ]
; CHECK-NEXT:    br label [[TMP31:%.*]]
; CHECK:       31:
; CHECK-NEXT:    [[TMP32:%.*]] = phi i64 [ [[BC_RESUME_VAL]], [[SCALAR_PH]] ], [ [[TMP39:%.*]], [[TMP31]] ]
; CHECK-NEXT:    [[TMP33:%.*]] = add nsw i64 [[TMP32]], [[TMP20]]
; CHECK-NEXT:    [[TMP34:%.*]] = getelementptr inbounds i16, ptr [[TMP2]], i64 [[TMP33]]
; CHECK-NEXT:    [[TMP35:%.*]] = load i16, ptr [[TMP34]], align 2
; CHECK-NEXT:    [[TMP36:%.*]] = sext i16 [[TMP35]] to i32
; CHECK-NEXT:    [[TMP37:%.*]] = mul nsw i32 [[TMP36]], [[TMP7]]
; CHECK-NEXT:    [[TMP38:%.*]] = getelementptr inbounds i32, ptr [[TMP1]], i64 [[TMP33]]
; CHECK-NEXT:    store i32 [[TMP37]], ptr [[TMP38]], align 4
; CHECK-NEXT:    [[TMP39]] = add nuw nsw i64 [[TMP32]], 1
; CHECK-NEXT:    [[TMP40:%.*]] = icmp eq i64 [[TMP39]], [[TMP21]]
; CHECK-NEXT:    br i1 [[TMP40]], label [[TMP41]], label [[TMP31]], !llvm.loop [[LOOP8:![0-9]+]]
; CHECK:       41:
; CHECK-NEXT:    [[TMP42]] = add nuw nsw i64 [[TMP19]], 1
; CHECK-NEXT:    [[TMP43:%.*]] = icmp eq i64 [[TMP42]], [[TMP9]]
; CHECK-NEXT:    br i1 [[TMP43]], label [[DOTLOOPEXIT:%.*]], label [[TMP18]]
; CHECK:       .loopexit:
; CHECK-NEXT:    br label [[TMP44]]
; CHECK:       44:
; CHECK-NEXT:    ret void
;

  %5 = icmp sgt i32 %0, 0
  br i1 %5, label %6, label %27

6:                                                ; preds = %4
  %7 = sext i16 %3 to i32
  %8 = sext i32 %0 to i64
  %9 = zext i32 %0 to i64
  br label %10

10:                                               ; preds = %6, %24
  %11 = phi i64 [ 0, %6 ], [ %25, %24 ]
  %12 = mul nsw i64 %11, %8
  %13 = zext i32 %0 to i64
  br label %14

14:                                               ; preds = %10, %14
  %15 = phi i64 [ 0, %10 ], [ %22, %14 ]
  %16 = add nsw i64 %15, %12
  %17 = getelementptr inbounds i16, ptr %2, i64 %16
  %18 = load i16, ptr %17, align 2
  %19 = sext i16 %18 to i32
  %20 = mul nsw i32 %19, %7
  %21 = getelementptr inbounds i32, ptr %1, i64 %16
  store i32 %20, ptr %21, align 4
  %22 = add nuw nsw i64 %15, 1
  %23 = icmp eq i64 %22, %13
  br i1 %23, label %24, label %14

24:                                               ; preds = %14
  %25 = add nuw nsw i64 %11, 1
  %26 = icmp eq i64 %25, %9
  br i1 %26, label %27, label %10

27:                                               ; preds = %24, %4
  ret void
}

attributes #0 = { nofree norecurse nounwind uwtable "disable-tail-calls"="false" "frame-pointer"="none" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "unsafe-fp-math"="false" "use-soft-float"="false" }
