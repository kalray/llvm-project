; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc -O3 -o - %s | FileCheck %s

; From the c src:
; a() {
;   int b = 0;
;   __kvx_x256 c;
;   __kvx_x512 d = __builtin_kvx_xbuildfvw(c, c);
;   for (int col;; col += 2) {
;     int e;
;     __kvx_x512 f, g;
;     __kvx_x1024 h;
;     __kvx_x256 i;
; #pragma unroll 3
;     for (; e < b; ++e)
;       f = d;
;     h = __builtin_kvx_xbuildfwm(f, g);
;     i = __builtin_kvx_xconvwbv(h, ".rz.sat");
;     *(__kvx_x256 *)col = i;
;   }
; }
target triple = "kvx-kalray-cos"

define i32 @a() {
; CHECK-LABEL: a:
; CHECK:       # %bb.0:
; CHECK-NEXT:    make $r0 = 0
; CHECK-NEXT:    goto .LBB0_1
; CHECK-NEXT:    ;;
; CHECK-NEXT:  .LBB0_2: # in Loop: Header=BB0_1 Depth=1
; CHECK-NEXT:    copyv $a2 = $a1
; CHECK-NEXT:    compw.eq $r2 = $r3, 1
; CHECK-NEXT:    ;;
; CHECK-NEXT:    copyv $a3 = $a0
; CHECK-NEXT:    sllw $r2 = $r2, 6
; CHECK-NEXT:    ;;
; CHECK-NEXT:    alignv $a1 = $a1, $a2, $r2
; CHECK-NEXT:    ;;
; CHECK-NEXT:    alignv $a0 = $a0, $a3, $r2
; CHECK-NEXT:    ;;
; CHECK-NEXT:  .LBB0_5: # in Loop: Header=BB0_1 Depth=1
; CHECK-NEXT:    convwbv0.rz.sat $a2_x = $a0a1a2a3
; CHECK-NEXT:    ;;
; CHECK-NEXT:    convwbv1.rz.sat $a2_y = $a0a1a2a3
; CHECK-NEXT:    ;;
; CHECK-NEXT:    convwbv2.rz.sat $a2_z = $a0a1a2a3
; CHECK-NEXT:    ;;
; CHECK-NEXT:    convwbv3.rz.sat $a2_t = $a0a1a2a3
; CHECK-NEXT:    ;;
; CHECK-NEXT:    sv 0[$r0] = $a2
; CHECK-NEXT:    addd $r0 = $r0, 2
; CHECK-NEXT:    copyd $r2 = $r1
; CHECK-NEXT:    ;;
; CHECK-NEXT:  .LBB0_1: # =>This Loop Header: Depth=1
; CHECK-NEXT:    # Child Loop BB0_4 Depth 2
; CHECK-NEXT:    maxw $r1 = $r2, 0
; CHECK-NEXT:    ;;
; CHECK-NEXT:    sbfw $r3 = $r2, $r1
; CHECK-NEXT:    ;;
; CHECK-NEXT:    muluwd $r4 = $r3, 0xaaaaaaab
; CHECK-NEXT:    compw.ltu $r5 = $r3, 2
; CHECK-NEXT:    ;;
; CHECK-NEXT:    srld $r4 = $r4, 32
; CHECK-NEXT:    ;;
; CHECK-NEXT:    srlw $r4 = $r4, 1
; CHECK-NEXT:    ;;
; CHECK-NEXT:    msbfw $r3 = $r4, 3
; CHECK-NEXT:    ;;
; CHECK-NEXT:    addw $r3 = $r3, 1
; CHECK-NEXT:    ;;
; CHECK-NEXT:    zxbd $r3 = $r3
; CHECK-NEXT:    ;;
; CHECK-NEXT:    muluwd $r4 = $r3, 0xaaaaaaab
; CHECK-NEXT:    ;;
; CHECK-NEXT:    srld $r4 = $r4, 32
; CHECK-NEXT:    ;;
; CHECK-NEXT:    srlw $r4 = $r4, 1
; CHECK-NEXT:    ;;
; CHECK-NEXT:    msbfw $r3 = $r4, 3
; CHECK-NEXT:    cb.odd $r5 ? .LBB0_2
; CHECK-NEXT:    ;;
; CHECK-NEXT:  # %bb.3: # in Loop: Header=BB0_1 Depth=1
; CHECK-NEXT:    zxbd $r3 = $r3
; CHECK-NEXT:    make $r5 = 1
; CHECK-NEXT:    ;;
; CHECK-NEXT:    compw.eq $r4 = $r3, 1
; CHECK-NEXT:    ;;
; CHECK-NEXT:    cmoved.even $r4 ? $r5 = 2
; CHECK-NEXT:    ;;
; CHECK-NEXT:    cmoved.weqz $r3 ? $r5 = 0
; CHECK-NEXT:    ;;
; CHECK-NEXT:    addw $r2 = $r5, $r2
; CHECK-NEXT:    ;;
; CHECK-NEXT:    addw $r2 = $r2, -3
; CHECK-NEXT:    ;;
; CHECK-NEXT:  .LBB0_4: # Parent Loop BB0_1 Depth=1
; CHECK-NEXT:    # => This Inner Loop Header: Depth=2
; CHECK-NEXT:    addw $r2 = $r2, 3
; CHECK-NEXT:    ;;
; CHECK-NEXT:    compw.lt $r3 = $r2, -2
; CHECK-NEXT:    ;;
; CHECK-NEXT:    cb.odd $r3 ? .LBB0_4
; CHECK-NEXT:    ;;
; CHECK-NEXT:    goto .LBB0_5
; CHECK-NEXT:    ;;
  %1 = tail call <512 x i1> @llvm.kvx.xbuildfvw(<256 x i1> undef, <256 x i1> undef)
  br label %2

2:
  %3 = phi i64 [ %30, %25 ], [ 0, %0 ]
  %4 = phi <512 x i1> [ %26, %25 ], [ undef, %0 ]
  %5 = phi i32 [ %7, %25 ], [ undef, %0 ]
  %6 = icmp sgt i32 %5, 0
  %7 = select i1 %6, i32 %5, i32 0
  %8 = sub i32 %7, %5
  %9 = urem i32 %8, 3
  %10 = trunc i32 %9 to i8
  %11 = add nuw nsw i8 %10, 1
  %12 = urem i8 %11, 3
  %13 = icmp eq i8 %12, 1
  %14 = select i1 %13, <512 x i1> %4, <512 x i1> %1
  %15 = icmp ult i32 %8, 2
  br i1 %15, label %25, label %16

16:
  %17 = icmp eq i8 %12, 0
  %18 = select i1 %13, i32 1, i32 2
  %19 = select i1 %17, i32 0, i32 %18
  %20 = add nsw i32 %5, %19
  br label %21

21:
  %22 = phi i32 [ %24, %21 ], [ %20, %16 ]
  %23 = icmp slt i32 %22, -2
  %24 = add nsw i32 %22, 3
  br i1 %23, label %21, label %25

25:
  %26 = phi <512 x i1> [ %14, %2 ], [ %1, %21 ]
  %27 = tail call <1024 x i1> @llvm.kvx.xbuildfwm(<512 x i1> %26, <512 x i1> undef)
  %28 = tail call <256 x i1> @llvm.kvx.xconvwbv(<1024 x i1> %27, i32 3, i32 0)
  %29 = inttoptr i64 %3 to <256 x i1>*
  store <256 x i1> %28, <256 x i1>* %29, align 32
  %30 = add i64 %3, 2
  br label %2
}

declare <512 x i1> @llvm.kvx.xbuildfvw(<256 x i1>, <256 x i1>)

declare <1024 x i1> @llvm.kvx.xbuildfwm(<512 x i1>, <512 x i1>)

declare <256 x i1> @llvm.kvx.xconvwbv(<1024 x i1>, i32, i32)
