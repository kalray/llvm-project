; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc -mcpu=kv3-1 -O2 -o - %s | FileCheck %s --check-prefixes=ALL,CV1
; RUN: llc -mcpu=kv3-2 -O2 -o - %s | FileCheck %s --check-prefixes=ALL,CV2
target triple = "kvx-kalray-cos"

define <4 x i8> @test_ret_const() #0 {
; ALL-LABEL: test_ret_const:
; ALL:       # %bb.0:
; ALL-NEXT:    make $r0 = 0x2010201
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  ret <4 x i8> <i8 1, i8 2, i8 1, i8 2>
}

define i8 @test_extract_0(<4 x i8> %a) #0 {
; ALL-LABEL: test_extract_0:
; ALL:       # %bb.0:
; ALL-NEXT:    zxbd $r0 = $r0
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %e = extractelement <4 x i8> %a, i8 0
  ret i8 %e
}

define i8 @test_extract_1(<4 x i8> %a) #0 {
; ALL-LABEL: test_extract_1:
; ALL:       # %bb.0:
; ALL-NEXT:    extfz $r0 = $r0, 15, 8
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %e = extractelement <4 x i8> %a, i8 1
  ret i8 %e
}

define i8 @test_extract_2(<4 x i8> %a) #0 {
; ALL-LABEL: test_extract_2:
; ALL:       # %bb.0:
; ALL-NEXT:    extfz $r0 = $r0, 23, 16
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %e = extractelement <4 x i8> %a, i8 2
  ret i8 %e
}

define i8 @test_extract_3(<4 x i8> %a) #0 {
; ALL-LABEL: test_extract_3:
; ALL:       # %bb.0:
; ALL-NEXT:    srlw $r0 = $r0, 24
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %e = extractelement <4 x i8> %a, i8 3
  ret i8 %e
}

define <4 x i8> @test_fma(<4 x i8> %a, <4 x i8> %b, <4 x i8> %c) #0 {
; ALL-LABEL: test_fma:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sxlbhq $r2 = $r2
; ALL-NEXT:    ;;
; ALL-NEXT:    maddhq $r0 = $r1, $r2
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %m = mul <4 x i8> %b, %c
  %ad = add <4 x i8> %a, %m
  ret <4 x i8> %ad
}

define <4 x i8> @test_fma_imm(<4 x i8> %a, <4 x i8> %b) #0 {
; CV1-LABEL: test_fma_imm:
; CV1:       # %bb.0:
; CV1-NEXT:    sxlbhq $r1 = $r1
; CV1-NEXT:    sxlbhq $r0 = $r0
; CV1-NEXT:    ;;
; CV1-NEXT:    maddhq $r0 = $r1, 0x3000100020007
; CV1-NEXT:    ;;
; CV1-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; CV1-NEXT:    ret
; CV1-NEXT:    ;;
;
; CV2-LABEL: test_fma_imm:
; CV2:       # %bb.0:
; CV2-NEXT:    sxlbhq $r1 = $r1
; CV2-NEXT:    sxlbhq $r0 = $r0
; CV2-NEXT:    make $r2 = 0x3000100020007
; CV2-NEXT:    ;;
; CV2-NEXT:    maddhq $r0 = $r1, $r2
; CV2-NEXT:    ;;
; CV2-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; CV2-NEXT:    ret
; CV2-NEXT:    ;;
  %m = mul <4 x i8> <i8 7, i8 2, i8 1, i8 3>, %b
  %ad = add <4 x i8> %a, %m
  ret <4 x i8> %ad
}


define <4 x i8> @test_fma_imm_2(<4 x i8> %a, <4 x i8> %b) #0 {
; CV1-LABEL: test_fma_imm_2:
; CV1:       # %bb.0:
; CV1-NEXT:    sxlbhq $r1 = $r1
; CV1-NEXT:    sxlbhq $r0 = $r0
; CV1-NEXT:    ;;
; CV1-NEXT:    maddhq $r0 = $r1, 0x2000100020001
; CV1-NEXT:    ;;
; CV1-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; CV1-NEXT:    ret
; CV1-NEXT:    ;;
;
; CV2-LABEL: test_fma_imm_2:
; CV2:       # %bb.0:
; CV2-NEXT:    sxlbhq $r1 = $r1
; CV2-NEXT:    sxlbhq $r0 = $r0
; CV2-NEXT:    make $r2 = 0x2000100020001
; CV2-NEXT:    ;;
; CV2-NEXT:    maddhq $r0 = $r1, $r2
; CV2-NEXT:    ;;
; CV2-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; CV2-NEXT:    ret
; CV2-NEXT:    ;;
  %m = mul <4 x i8> <i8 1, i8 2, i8 1, i8 2>, %b
  %ad = add <4 x i8> %a, %m
  ret <4 x i8> %ad
}

define i8 @test_extract_i(<4 x i8> %a, i64 %idx) #0 {
; ALL-LABEL: test_extract_i:
; ALL:       # %bb.0:
; ALL-NEXT:    sllw $r1 = $r1, 3
; ALL-NEXT:    ;;
; ALL-NEXT:    srlw $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    zxbd $r0 = $r0
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %e = extractelement <4 x i8> %a, i64 %idx
  ret i8 %e
}

define <4 x i8> @test_add(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_add:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    addhq $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = add <4 x i8> %a, %b
  ret <4 x i8> %r
}

define <4 x i8> @test_add_imm_0(<4 x i8> %a) #0 {
; ALL-LABEL: test_add_imm_0:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    addhq.@ $r0 = $r0, 0x20001
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = add <4 x i8> <i8 1, i8 2, i8 1, i8 2>, %a
  ret <4 x i8> %r
}

define <4 x i8> @test_add_imm_1(<4 x i8> %a) #0 {
; ALL-LABEL: test_add_imm_1:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    addhq.@ $r0 = $r0, 0x20001
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = add <4 x i8> %a, <i8 1, i8 2, i8 1, i8 2>
  ret <4 x i8> %r
}

define <4 x i8> @test_sub(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_sub:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbfhq $r0 = $r1, $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = sub <4 x i8> %a, %b
  ret <4 x i8> %r
}

define <4 x i8> @test_sub_imm(<4 x i8> %a) #0 {
; ALL-LABEL: test_sub_imm:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    addhq.@ $r0 = $r0, 0xfffeffff
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = sub <4 x i8> %a, <i8 1, i8 2, i8 1, i8 2>
  ret <4 x i8> %r
}

define <4 x i8> @test_sub_fromimm(<4 x i8> %a) #0 {
; ALL-LABEL: test_sub_fromimm:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sbfhq.@ $r0 = $r0, 0x20001
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = sub <4 x i8> <i8 1, i8 2, i8 1, i8 2>, %a
  ret <4 x i8> %r
}

define <4 x i8> @test_neg(<4 x i8> %a) #0 {
; ALL-LABEL: test_neg:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    neghq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = sub <4 x i8> <i8 0, i8 0, i8 0, i8 0>, %a
  ret <4 x i8> %r
}

define <4 x i8> @test_mul(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_mul:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    mulhq $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = mul <4 x i8> %a, %b
  ret <4 x i8> %r
}

define <4 x i8> @test_mul_2(<4 x i8> %a, <4 x i8> %b, <4 x i8> %c) #0 {
; ALL-LABEL: test_mul_2:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    mulhq $r0 = $r0, $r1
; ALL-NEXT:    sxlbhq $r1 = $r2
; ALL-NEXT:    ;;
; ALL-NEXT:    mulhq $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = mul <4 x i8> %a, %b
  %r1 = mul <4 x i8> %r, %c
  ret <4 x i8> %r1
}

define <4 x i8> @test_div(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_div:
; ALL:       # %bb.0:
; ALL-NEXT:    addd $r12 = $r12, -64
; ALL-NEXT:    get $r16 = $ra
; ALL-NEXT:    ;;
; ALL-NEXT:    sd 56[$r12] = $r16
; ALL-NEXT:    ;;
; ALL-NEXT:    sq 40[$r12] = $r20r21
; ALL-NEXT:    ;;
; ALL-NEXT:    sq 24[$r12] = $r18r19
; ALL-NEXT:    copyd $r18 = $r1
; ALL-NEXT:    copyd $r19 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    srlw $r0 = $r19, 24
; ALL-NEXT:    srlw $r1 = $r18, 24
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r0
; ALL-NEXT:    sxbd $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sxwd $r0 = $r0
; ALL-NEXT:    sxwd $r1 = $r1
; ALL-NEXT:    call __divdi3
; ALL-NEXT:    ;;
; ALL-NEXT:    extfz $r1 = $r18, 23, 16
; ALL-NEXT:    copyd $r20 = $r0
; ALL-NEXT:    extfz $r0 = $r19, 23, 16
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r0
; ALL-NEXT:    sxbd $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sxwd $r0 = $r0
; ALL-NEXT:    sxwd $r1 = $r1
; ALL-NEXT:    call __divdi3
; ALL-NEXT:    ;;
; ALL-NEXT:    copyd $r21 = $r0
; ALL-NEXT:    extfz $r0 = $r19, 15, 8
; ALL-NEXT:    extfz $r1 = $r18, 15, 8
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r0
; ALL-NEXT:    sxbd $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    insf $r21 = $r20, 15, 8
; ALL-NEXT:    sxwd $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sxwd $r1 = $r1
; ALL-NEXT:    call __divdi3
; ALL-NEXT:    ;;
; ALL-NEXT:    zxbd $r1 = $r18
; ALL-NEXT:    copyd $r20 = $r0
; ALL-NEXT:    zxbd $r0 = $r19
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r0
; ALL-NEXT:    sxbd $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sxwd $r0 = $r0
; ALL-NEXT:    sxwd $r1 = $r1
; ALL-NEXT:    call __divdi3
; ALL-NEXT:    ;;
; ALL-NEXT:    insf $r0 = $r20, 15, 8
; ALL-NEXT:    lq $r18r19 = 24[$r12]
; ALL-NEXT:    ;;
; ALL-NEXT:    insf $r0 = $r21, 31, 16
; ALL-NEXT:    lq $r20r21 = 40[$r12]
; ALL-NEXT:    ;;
; ALL-NEXT:    ld $r16 = 56[$r12]
; ALL-NEXT:    ;;
; ALL-NEXT:    set $ra = $r16
; ALL-NEXT:    addd $r12 = $r12, 64
; ALL-NEXT:    ;;
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = sdiv <4 x i8> %a, %b
  ret <4 x i8> %r
}

; TODO: Eliminate duplicate sxwd after a sxbd
define <4 x i8> @test_rem(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_rem:
; ALL:       # %bb.0:
; ALL-NEXT:    addd $r12 = $r12, -64
; ALL-NEXT:    get $r16 = $ra
; ALL-NEXT:    ;;
; ALL-NEXT:    sd 56[$r12] = $r16
; ALL-NEXT:    ;;
; ALL-NEXT:    sq 40[$r12] = $r20r21
; ALL-NEXT:    ;;
; ALL-NEXT:    sq 24[$r12] = $r18r19
; ALL-NEXT:    copyd $r18 = $r1
; ALL-NEXT:    copyd $r19 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    srlw $r0 = $r19, 24
; ALL-NEXT:    srlw $r1 = $r18, 24
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r0
; ALL-NEXT:    sxbd $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sxwd $r0 = $r0
; ALL-NEXT:    sxwd $r1 = $r1
; ALL-NEXT:    call __moddi3
; ALL-NEXT:    ;;
; ALL-NEXT:    extfz $r1 = $r18, 23, 16
; ALL-NEXT:    copyd $r20 = $r0
; ALL-NEXT:    extfz $r0 = $r19, 23, 16
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r0
; ALL-NEXT:    sxbd $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sxwd $r0 = $r0
; ALL-NEXT:    sxwd $r1 = $r1
; ALL-NEXT:    call __moddi3
; ALL-NEXT:    ;;
; ALL-NEXT:    copyd $r21 = $r0
; ALL-NEXT:    extfz $r0 = $r19, 15, 8
; ALL-NEXT:    extfz $r1 = $r18, 15, 8
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r0
; ALL-NEXT:    sxbd $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    insf $r21 = $r20, 15, 8
; ALL-NEXT:    sxwd $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sxwd $r1 = $r1
; ALL-NEXT:    call __moddi3
; ALL-NEXT:    ;;
; ALL-NEXT:    zxbd $r1 = $r18
; ALL-NEXT:    copyd $r20 = $r0
; ALL-NEXT:    zxbd $r0 = $r19
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r0
; ALL-NEXT:    sxbd $r1 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sxwd $r0 = $r0
; ALL-NEXT:    sxwd $r1 = $r1
; ALL-NEXT:    call __moddi3
; ALL-NEXT:    ;;
; ALL-NEXT:    insf $r0 = $r20, 15, 8
; ALL-NEXT:    lq $r18r19 = 24[$r12]
; ALL-NEXT:    ;;
; ALL-NEXT:    insf $r0 = $r21, 31, 16
; ALL-NEXT:    lq $r20r21 = 40[$r12]
; ALL-NEXT:    ;;
; ALL-NEXT:    ld $r16 = 56[$r12]
; ALL-NEXT:    ;;
; ALL-NEXT:    set $ra = $r16
; ALL-NEXT:    addd $r12 = $r12, 64
; ALL-NEXT:    ;;
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = srem <4 x i8> %a, %b
  ret <4 x i8> %r
}

define void @test_ldst_v4i8(<4 x i8>* %a, <4 x i8>* %b) {
; ALL-LABEL: test_ldst_v4i8:
; ALL:       # %bb.0:
; ALL-NEXT:    lwz $r0 = 0[$r0]
; ALL-NEXT:    ;;
; ALL-NEXT:    sw 0[$r1] = $r0
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %t1 = load <4 x i8>, <4 x i8>* %a
  store <4 x i8> %t1, <4 x i8>* %b, align 16
  ret void
}

declare <4 x i8> @test_callee(<4 x i8> %a, <4 x i8> %b) #0

define <4 x i8> @test_call(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_call:
; ALL:       # %bb.0:
; ALL-NEXT:    addd $r12 = $r12, -32
; ALL-NEXT:    get $r16 = $ra
; ALL-NEXT:    ;;
; ALL-NEXT:    sd 24[$r12] = $r16
; ALL-NEXT:    call test_callee
; ALL-NEXT:    ;;
; ALL-NEXT:    ld $r16 = 24[$r12]
; ALL-NEXT:    ;;
; ALL-NEXT:    set $ra = $r16
; ALL-NEXT:    addd $r12 = $r12, 32
; ALL-NEXT:    ;;
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = call <4 x i8> @test_callee(<4 x i8> %a, <4 x i8> %b)
  ret <4 x i8> %r
}

define <4 x i8> @test_call_flipped(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_call_flipped:
; ALL:       # %bb.0:
; ALL-NEXT:    addd $r12 = $r12, -32
; ALL-NEXT:    get $r16 = $ra
; ALL-NEXT:    ;;
; ALL-NEXT:    sd 24[$r12] = $r16
; ALL-NEXT:    copyd $r2 = $r0
; ALL-NEXT:    copyd $r0 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    copyd $r1 = $r2
; ALL-NEXT:    call test_callee
; ALL-NEXT:    ;;
; ALL-NEXT:    ld $r16 = 24[$r12]
; ALL-NEXT:    ;;
; ALL-NEXT:    set $ra = $r16
; ALL-NEXT:    addd $r12 = $r12, 32
; ALL-NEXT:    ;;
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = call <4 x i8> @test_callee(<4 x i8> %b, <4 x i8> %a)
  ret <4 x i8> %r
}

; Can perform swap in a single bundle
define <4 x i8> @test_tailcall_flipped(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_tailcall_flipped:
; ALL:       # %bb.0:
; ALL-NEXT:    copyd $r2 = $r0
; ALL-NEXT:    copyd $r0 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    copyd $r1 = $r2
; ALL-NEXT:    goto test_callee
; ALL-NEXT:    ;;
  %r = tail call <4 x i8> @test_callee(<4 x i8> %b, <4 x i8> %a)
  ret <4 x i8> %r
}

define <4 x i8> @test_select(<4 x i8> %a, <4 x i8> %b, i1 zeroext %c) #0 {
; ALL-LABEL: test_select:
; ALL:       # %bb.0:
; ALL-NEXT:    cmoved.even $r2 ? $r0 = $r1
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = select i1 %c, <4 x i8> %a, <4 x i8> %b
  ret <4 x i8> %r
}

define <4 x i8> @test_select_cc(<4 x i8> %a, <4 x i8> %b, <4 x i8> %c, <4 x i8> %d) #0 {
; ALL-LABEL: test_select_cc:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r3 = $r3
; ALL-NEXT:    sxlbhq $r2 = $r2
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x8000400020001
; ALL-NEXT:    sbmm8 $r1 = $r1, 0x8000400020001
; ALL-NEXT:    compnhq.lt $r2 = $r2, $r3
; ALL-NEXT:    ;;
; ALL-NEXT:    andd $r2 = $r2, 0xff00ff00ff00ff
; ALL-NEXT:    ;;
; ALL-NEXT:    cmovehq.even $r2 ? $r0 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %cc = icmp slt <4 x i8> %c, %d
  %r = select <4 x i1> %cc, <4 x i8> %a, <4 x i8> %b
  ret <4 x i8> %r
}

define <4 x i64> @test_select_cc_f32_f32(<4 x i64> %a, <4 x i64> %b, <4 x i8> %c, <4 x i8> %d) #0 {
; ALL-LABEL: test_select_cc_f32_f32:
; ALL:       # %bb.0:
; ALL-NEXT:    sbmm8 $r9 = $r9, 0x8000400020001
; ALL-NEXT:    sbmm8 $r8 = $r8, 0x8000400020001
; ALL-NEXT:    ;;
; ALL-NEXT:    compnhq.ltu $r8 = $r8, $r9
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r8 = $r8, 0x40100401
; ALL-NEXT:    ;;
; ALL-NEXT:    srlw $r9 = $r8, 24
; ALL-NEXT:    extfz $r10 = $r8, 23, 16
; ALL-NEXT:    zxbd $r11 = $r8
; ALL-NEXT:    extfz $r8 = $r8, 15, 8
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r9 = $r9
; ALL-NEXT:    sxbd $r10 = $r10
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r11 = $r11
; ALL-NEXT:    sxbd $r8 = $r8
; ALL-NEXT:    ;;
; ALL-NEXT:    cmoved.dnez $r10 ? $r6 = $r2
; ALL-NEXT:    cmoved.dnez $r9 ? $r7 = $r3
; ALL-NEXT:    ;;
; ALL-NEXT:    cmoved.dnez $r11 ? $r4 = $r0
; ALL-NEXT:    cmoved.dnez $r8 ? $r5 = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    copyd $r0 = $r4
; ALL-NEXT:    copyd $r1 = $r5
; ALL-NEXT:    copyd $r2 = $r6
; ALL-NEXT:    copyd $r3 = $r7
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %cc = icmp ult <4 x i8> %c, %d
  %r = select <4 x i1> %cc, <4 x i64> %a, <4 x i64> %b
  ret <4 x i64> %r
}

define <4 x i1> @test_icmp_ule(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_icmp_ule:
; ALL:       # %bb.0:
; ALL-NEXT:    sbmm8 $r1 = $r1, 0x8000400020001
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x8000400020001
; ALL-NEXT:    ;;
; ALL-NEXT:    compnhq.leu $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = icmp ule <4 x i8> %a, %b
  ret <4 x i1> %r
}

define <4 x i1> @test_icmp_slt(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_icmp_slt:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    compnhq.lt $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = icmp slt <4 x i8> %a, %b
  ret <4 x i1> %r
}

define <4 x i1> @test_icmp_ugt(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_icmp_ugt:
; ALL:       # %bb.0:
; ALL-NEXT:    sbmm8 $r1 = $r1, 0x8000400020001
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x8000400020001
; ALL-NEXT:    ;;
; ALL-NEXT:    compnhq.gtu $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = icmp ugt <4 x i8> %a, %b
  ret <4 x i1> %r
}

define <4 x i1> @test_icmp_uge(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_icmp_uge:
; ALL:       # %bb.0:
; ALL-NEXT:    sbmm8 $r1 = $r1, 0x8000400020001
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x8000400020001
; ALL-NEXT:    ;;
; ALL-NEXT:    compnhq.geu $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = icmp uge <4 x i8> %a, %b
  ret <4 x i1> %r
}

define <4 x i1> @test_icmp_ult(<4 x i8> %a, <4 x i8> %b) #0 {
; ALL-LABEL: test_icmp_ult:
; ALL:       # %bb.0:
; ALL-NEXT:    sbmm8 $r1 = $r1, 0x8000400020001
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x8000400020001
; ALL-NEXT:    ;;
; ALL-NEXT:    compnhq.ltu $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = icmp ult <4 x i8> %a, %b
  ret <4 x i1> %r
}

define <4 x i64> @test_sext_2xi64(<4 x i8> %a) #0 {
; ALL-LABEL: test_sext_2xi64:
; ALL:       # %bb.0:
; ALL-NEXT:    zxbd $r1 = $r0
; ALL-NEXT:    extfz $r2 = $r0, 15, 8
; ALL-NEXT:    extfz $r3 = $r0, 23, 16
; ALL-NEXT:    srlw $r4 = $r0, 24
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r0 = $r1
; ALL-NEXT:    sxbd $r1 = $r2
; ALL-NEXT:    ;;
; ALL-NEXT:    sxbd $r2 = $r3
; ALL-NEXT:    sxbd $r3 = $r4
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = sext <4 x i8> %a to <4 x i64>
  ret <4 x i64> %r
}

declare <4 x i8> @llvm.abs.v4i8(<4 x i8>, i1) #0

define <4 x i8> @test_abs(<4 x i8> %a) #0 {
; ALL-LABEL: test_abs:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    abshq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %r = call <4 x i8> @llvm.abs.v4i8(<4 x i8> %a, i1 false)
  ret <4 x i8> %r
}

define <4 x i8> @test_insertelement0(<4 x i8> %a, i8 %x) #0 {
; ALL-LABEL: test_insertelement0:
; ALL:       # %bb.0:
; ALL-NEXT:    insf $r0 = $r1, 7, 0
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %i = insertelement <4 x i8> %a, i8 %x, i64 0
  ret <4 x i8> %i
}

define <4 x i8> @test_insertelement1(<4 x i8> %a, i8 %x) #0 {
; ALL-LABEL: test_insertelement1:
; ALL:       # %bb.0:
; ALL-NEXT:    insf $r0 = $r1, 15, 8
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %i = insertelement <4 x i8> %a, i8 %x, i64 1
  ret <4 x i8> %i
}

define <4 x i8> @test_insertelement2(<4 x i8> %a, i8 %x) #0 {
; ALL-LABEL: test_insertelement2:
; ALL:       # %bb.0:
; ALL-NEXT:    insf $r0 = $r1, 23, 16
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %i = insertelement <4 x i8> %a, i8 %x, i64 2
  ret <4 x i8> %i
}

define <4 x i8> @test_insertelement3(<4 x i8> %a, i8 %x) #0 {
; ALL-LABEL: test_insertelement3:
; ALL:       # %bb.0:
; ALL-NEXT:    insf $r0 = $r1, 31, 24
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %i = insertelement <4 x i8> %a, i8 %x, i64 3
  ret <4 x i8> %i
}

define <4 x i8> @test_insertelement(<4 x i8> %a, i8 %x, i64 %p) #0 {
; ALL-LABEL: test_insertelement:
; ALL:       # %bb.0:
; ALL-NEXT:    addd $r12 = $r12, -32
; ALL-NEXT:    andd $r2 = $r2, 3
; ALL-NEXT:    ;;
; ALL-NEXT:    addd $r3 = $r12, 28
; ALL-NEXT:    sw 28[$r12] = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sb $r2[$r3] = $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    lwz $r0 = 28[$r12]
; ALL-NEXT:    addd $r12 = $r12, 32
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %i = insertelement <4 x i8> %a, i8 %x, i64 %p
  ret <4 x i8> %i
}

define <4 x i8> @mulsub(<4 x i8> %a, <4 x i8> %b, <4 x i8> %c) #0 {
; ALL-LABEL: mulsub:
; ALL:       # %bb.0:
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    sxlbhq $r2 = $r2
; ALL-NEXT:    ;;
; ALL-NEXT:    msbfhq $r0 = $r1, $r2
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %mul = mul <4 x i8> %b, %c
  %sub = sub <4 x i8> %a, %mul
  ret <4 x i8> %sub
}

define <4 x i8> @vnot(<4 x i8> %a) #0 {
; ALL-LABEL: vnot:
; ALL:       # %bb.0:
; ALL-NEXT:    notw $r0 = $r0
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %vnot = xor <4 x i8> %a, <i8 -1, i8 -1, i8 -1, i8 -1>
  ret <4 x i8> %vnot
}

define <4 x i8> @nandw_v2i8_rr(<4 x i8> %0, <4 x i8> %1) {
; ALL-LABEL: nandw_v2i8_rr:
; ALL:       # %bb.0:
; ALL-NEXT:    nandw $r0 = $r1, $r0
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %3 = and <4 x i8> %1, %0
  %4 = xor <4 x i8> %3, <i8 -1, i8 -1, i8 -1, i8 -1>
  ret <4 x i8> %4
}

define <4 x i8> @nandw_v2i8_ri10(<4 x i8> %0) {
; ALL-LABEL: nandw_v2i8_ri10:
; ALL:       # %bb.0:
; ALL-NEXT:    nandw $r0 = $r0, 0xff00ff
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %2 = and <4 x i8> %0, <i8 1023, i8 0, i8 1023, i8 0>
  %3 = xor <4 x i8> %2, <i8 -1, i8 -1, i8 -1, i8 -1>
  ret <4 x i8> %3
}

define <4 x i8> @nandw_v2i8_ri37(<4 x i8> %0) {
; ALL-LABEL: nandw_v2i8_ri37:
; ALL:       # %bb.0:
; ALL-NEXT:    nandw $r0 = $r0, 0xfc00fc
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %2 = and <4 x i8> %0, <i8 252, i8 0, i8 252, i8 0>
  %3 = xor <4 x i8> %2, <i8 -1, i8 -1, i8 -1, i8 -1>
  ret <4 x i8> %3
}

define <4 x i8> @nandw_v2i8_ri37_2(<4 x i8> %0) {
; ALL-LABEL: nandw_v2i8_ri37_2:
; ALL:       # %bb.0:
; ALL-NEXT:    nandw $r0 = $r0, 0xd0d0d0d
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %2 = and <4 x i8> %0, <i8 13, i8 13, i8 13, i8 13>
  %3 = xor <4 x i8> %2, <i8 -1, i8 -1, i8 -1, i8 -1>
  ret <4 x i8> %3
}

define <4 x i8> @concat(<2 x i8> %a, <2 x i8> %b){
; ALL-LABEL: concat:
; ALL:       # %bb.0:
; ALL-NEXT:    insf $r0 = $r1, 31, 16
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
  %v = shufflevector <2 x i8> %a, <2 x i8> %b, <4 x i32> <i32 0, i32 1, i32 2, i32 3>
  ret <4 x i8> %v
}

define  <4 x i8> @v4_maxhq_rr_i8(<4 x i8> %a, <4 x i8> %b) {
; ALL-LABEL: v4_maxhq_rr_i8:
; ALL:       # %bb.0: # %entry
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    maxhq $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
entry:
  %0 = call <4 x i8> @llvm.smax.v4i8(<4 x i8> %a, <4 x i8> %b)
  ret <4 x i8> %0
}

define  <4 x i8> @v4_minhq_rr_i8(<4 x i8> %a, <4 x i8> %b) {
; ALL-LABEL: v4_minhq_rr_i8:
; ALL:       # %bb.0: # %entry
; ALL-NEXT:    sxlbhq $r1 = $r1
; ALL-NEXT:    sxlbhq $r0 = $r0
; ALL-NEXT:    ;;
; ALL-NEXT:    minhq $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
entry:
  %0 = call <4 x i8> @llvm.smin.v4i8(<4 x i8> %a, <4 x i8> %b)
  ret <4 x i8> %0
}

define  <4 x i8> @v4_umaxhq_rr_i8(<4 x i8> %a, <4 x i8> %b) {
; ALL-LABEL: v4_umaxhq_rr_i8:
; ALL:       # %bb.0: # %entry
; ALL-NEXT:    sbmm8 $r1 = $r1, 0x8000400020001
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x8000400020001
; ALL-NEXT:    ;;
; ALL-NEXT:    maxuhq $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
entry:
  %0 = call <4 x i8> @llvm.umax.v4i8(<4 x i8> %a, <4 x i8> %b)
  ret <4 x i8> %0
}

define  <4 x i8> @v4_uminhq_rr_i8(<4 x i8> %a, <4 x i8> %b) {
; ALL-LABEL: v4_uminhq_rr_i8:
; ALL:       # %bb.0: # %entry
; ALL-NEXT:    sbmm8 $r1 = $r1, 0x8000400020001
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x8000400020001
; ALL-NEXT:    ;;
; ALL-NEXT:    minuhq $r0 = $r0, $r1
; ALL-NEXT:    ;;
; ALL-NEXT:    sbmm8 $r0 = $r0, 0x40100401
; ALL-NEXT:    ret
; ALL-NEXT:    ;;
entry:
  %0 = call <4 x i8> @llvm.umin.v4i8(<4 x i8> %a, <4 x i8> %b)
  ret <4 x i8> %0
}

declare <4 x i8> @llvm.smax.v4i8(<4 x i8> %a, <4 x i8> %b)
declare <4 x i8> @llvm.smin.v4i8(<4 x i8> %a, <4 x i8> %b)
declare <4 x i8> @llvm.umax.v4i8(<4 x i8> %a, <4 x i8> %b)
declare <4 x i8> @llvm.umin.v4i8(<4 x i8> %a, <4 x i8> %b)

attributes #0 = { nounwind }
