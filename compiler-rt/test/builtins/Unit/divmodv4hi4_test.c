// RUN: %clang_builtins %s %librt -o %t && %run %t
// REQUIRES: librt_has_divmodv4hi4

#include <stdio.h>

// Returns: a / b, if (r) r = a % b

typedef short v4hi __attribute__((__vector_size__(8)));
v4hi __divmodv4hi4(v4hi a, v4hi b, v4hi *r);

int test__divmodv4hi4(v4hi a, v4hi b, v4hi expected_q, v4hi expected_rem) {
  v4hi rem;
  v4hi q = __divmodv4hi4(a, b, &rem);
  int res = 0;
  for (int lane = 0; lane < 4; ++lane)
    if (q[lane] != expected_q[lane] || rem[lane] != expected_rem[lane]) {
      printf("error in __divmodv4hi4 (lane %d): %X divmod %X = q(%X), rem(%X), "
             "expected q(%X), rem (%X)\n",
             lane, a[lane], b[lane], q[lane], rem[lane], expected_q[lane],
             expected_rem[lane]);
      res = 1;
    }
  return res;
}

v4hi tests[][4] = {
    {{1, -1, 12, -101}, {10, 11, -11, -100}, {0, 0, -1, 1}, {1, -1, 1, -1}},
    {{1015, -9594, 0, -90}, {101, 95, 1, 90}, {10, -100, 0, -1}, {5, -94, 0, 0}},
    {{-6688, -11103, 6042, 16639},
     {16428, 8821, 19740, 194},
     {0, -1, 0, 85},
     {-6688, -2282, 6042, 149}},
    {{18255, 22085, 13134, 11549},
     {-3771, 23476, 10803, 23286},
     {-4, 0, 1, 0},
     {3171, 22085, 2331, 11549}},
    {{23773, -12717, -1687, 9987},
     {6149, 31871, -10, 2436},
     {3, 0, 168, 4},
     {5326, -12717, -7, 243}},
    {{19528, 18216, 6192, 5204},
     {9649, -4190, 4819, -10966},
     {2, -4, 1, 0},
     {230, 1456, 1373, 5204}},
    {{-2585, -4975, 5213, -12328},
     {23056, 27373, 20493, -8349},
     {0, 0, 0, 1},
     {-2585, -4975, 5213, -3979}},
    {{18791, 17023, -6510, 11831},
     {-5411, -16631, 19224, -545},
     {-3, -1, 0, -21},
     {2558, 392, -6510, 386}},
    {{23335, -10940, 21064, 8701},
     {19117, 21105, -4096, 18629},
     {1, 0, -5, 0},
     {4218, -10940, 584, 8701}},
    {{1746, 10694, 23879, 11386},
     {22527, -6997, 3126, -30404},
     {0, -1, 7, 0},
     {1746, 3697, 1997, 11386}},
    {{15180, 17323, 14901, 21373},
     {14970, 14495, 5024, 30627},
     {1, 1, 2, 0},
     {210, 2828, 4853, 21373}},
    {{-9080, -6179, 6831, 10523},
     {16702, 29183, 28458, -25752},
     {0, 0, 0, 0},
     {-9080, -6179, 6831, 10523}},
    {{-2317, 20868, -5749, 15563},
     {-12560, 11369, 18194, 6241},
     {0, 1, 0, 2},
     {-2317, 9499, -5749, 3081}},
};

int main() {
  const unsigned N = sizeof(tests) / sizeof(tests[0]);
  unsigned i;
  for (i = 0; i < N; ++i)
    if (test__divmodv4hi4(tests[i][0], tests[i][1], tests[i][2], tests[i][3]))
      return 1;

  return 0;
}
