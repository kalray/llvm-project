// RUN: %clang_builtins %s %librt -o %t && %run %t
// REQUIRES: librt_has_udivmodv8hi4

#include <stdio.h>

// Returns: a / b, if (r) r = a % b

typedef unsigned short elt;
typedef elt vt __attribute__((__vector_size__(16)));
vt __udivmodv8hi4(vt a, vt b, vt *r);

int test__udivmodv8hi4(vt a, vt b, vt expected_q, vt expected_rem) {
  const int N = sizeof(vt) / sizeof(elt);
  vt rem;
  vt q = __udivmodv8hi4(a, b, &rem);
  int res = 0;
  for (int lane = 0; lane < N; ++lane)
    if (q[lane] != expected_q[lane] || rem[lane] != expected_rem[lane]) {
      printf(
          "error in __udivmodv8hi4 (lane %d): %X divmod %X = q(%X), rem(%X), "
          "expected q(%X), rem (%X)\n",
          lane, a[lane], b[lane], q[lane], rem[lane], expected_q[lane],
          expected_rem[lane]);
      res = 1;
    }
  return res;
}

vt tests[][4] = {
    {{11195, 49144, 6315, 57045, 37833, 51497, 45362, 24167},
     {57272, 48830, 29232, 23182, 48006, 17054, 25841, 50907},
     {0, 1, 0, 2, 0, 3, 1, 0},
     {11195, 314, 6315, 10681, 37833, 335, 19521, 24167}},
    {{55379, 37735, 46892, 5441, 29872, 7208, 35732, 25603},
     {48457, 63166, 63180, 21375, 55888, 17397, 14545, 52735},
     {1, 0, 0, 0, 0, 0, 2, 0},
     {6922, 37735, 46892, 5441, 29872, 7208, 6642, 25603}},
    {{51738, 8363, 5387, 61644, 1676, 10106, 25048, 10140},
     {41611, 29663, 9576, 22736, 50423, 57675, 13679, 10597},
     {1, 0, 0, 2, 0, 0, 1, 0},
     {10127, 8363, 5387, 16172, 1676, 10106, 11369, 10140}},
    {{46215, 14328, 49924, 26983, 42520, 60944, 32927, 45051},
     {38706, 48228, 43171, 57630, 32046, 51540, 20432, 7567},
     {1, 0, 1, 0, 1, 1, 1, 5},
     {7509, 14328, 6753, 26983, 10474, 9404, 12495, 7216}},
    {{9462, 29273, 21272, 62427, 23474, 26097, 6638, 62596},
     {6499, 52074, 63500, 36805, 4519, 52083, 16680, 4265},
     {1, 0, 0, 1, 5, 0, 0, 14},
     {2963, 29273, 21272, 25622, 879, 26097, 6638, 2886}},
    {{63325, 51480, 52766, 37438, 18524, 63080, 37976, 28643},
     {27567, 24252, 23152, 10473, 48267, 64826, 34548, 44968},
     {2, 2, 2, 3, 0, 0, 1, 0},
     {8191, 2976, 6462, 6019, 18524, 63080, 3428, 28643}},
    {{48941, 4525, 3494, 50747, 46104, 7947, 19886, 4882},
     {53269, 26893, 54266, 18771, 28655, 8147, 57968, 64748},
     {0, 0, 0, 2, 1, 0, 0, 0},
     {48941, 4525, 3494, 13205, 17449, 7947, 19886, 4882}},
    {{20783, 34585, 28391, 14005, 47815, 89, 38416, 31288},
     {44998, 54473, 11865, 14173, 50216, 63309, 10195, 10846},
     {0, 0, 2, 0, 0, 0, 3, 2},
     {20783, 34585, 4661, 14005, 47815, 89, 7831, 9596}},
    {{56212, 51702, 37912, 6520, 54273, 48967, 59533, 33565},
     {13217, 32090, 41787, 45061, 9643, 42709, 65515, 47995},
     {4, 1, 0, 0, 5, 1, 0, 0},
     {3344, 19612, 37912, 6520, 6058, 6258, 59533, 33565}},
    {{14586, 65493, 10431, 45585, 45979, 64631, 42505, 42917},
     {58668, 64291, 35954, 28255, 58491, 16701, 50571, 7530},
     {0, 1, 0, 1, 0, 3, 0, 5},
     {14586, 1202, 10431, 17330, 45979, 14528, 42505, 5267}},
    {{27522, 64314, 56943, 30411, 16176, 55356, 55261, 48271},
     {23249, 32449, 61832, 49939, 17720, 43629, 44813, 27014},
     {1, 1, 0, 0, 0, 1, 1, 1},
     {4273, 31865, 56943, 30411, 16176, 11727, 10448, 21257}},
};

int main() {
  const unsigned N = sizeof(tests) / sizeof(tests[0]);
  unsigned i;
  for (i = 0; i < N; ++i)
    if (test__udivmodv8hi4(tests[i][0], tests[i][1], tests[i][2], tests[i][3]))
      return 1;

  return 0;
}
