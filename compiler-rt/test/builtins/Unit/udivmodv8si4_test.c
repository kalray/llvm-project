// RUN: %clang_builtins %s %librt -o %t && %run %t
// REQUIRES: librt_has_udivmodv8si4

#include <stdio.h>

// Returns: a / b, if (r) r = a % b

typedef unsigned elt;
typedef elt vt __attribute__((__vector_size__(32)));
vt __udivmodv8si4(vt a, vt b, vt *r);

int test__udivmodv8si4(vt a, vt b, vt expected_q, vt expected_rem) {
  const int N = sizeof(vt) / sizeof(elt);
  vt rem;
  vt q = __udivmodv8si4(a, b, &rem);
  int res = 0;
  for (int lane = 0; lane < N; ++lane)
    if (q[lane] != expected_q[lane] || rem[lane] != expected_rem[lane]) {
      printf("error in __udivmodv8si4 (lane %d): %d divmod %d = q(%d), "
             "rem(%d), expected q(%d), rem (%d)\n",
             lane, a[lane], b[lane], q[lane], rem[lane], expected_q[lane],
             expected_rem[lane]);
      res = 1;
    }
  return res;
}

vt tests[][4] = {
    {{3856616591, 3567268931, 396004311, 1090515857, 1076654944, 578063529,
      1293662684, 12667575},
     {1196451267, 1447482302, 860822517, 751371755, 191238140, 1688189168,
      312090319, 1516409980},
     {3, 2, 0, 1, 5, 0, 4, 0},
     {267262790, 672304327, 396004311, 339144102, 120464244, 578063529,
      45301408, 12667575}},
    {{1558326573, 3461495991, 4184306306, 654583243, 195225966, 641363869,
      4141526708, 3697687145},
     {1546896174, 1866170952, 790816378, 679945946, 403804297, 1136941377,
      361633808, 3573011261},
     {1, 1, 5, 0, 0, 0, 11, 1},
     {11430399, 1595325039, 230224416, 654583243, 195225966, 641363869,
      163554820, 124675884}},
    {{4125387956, 3969177753, 341621272, 3486952253, 1496005628, 1698607573,
      1253108636, 3406684656},
     {1242993097, 2711024350, 4098508603, 1429927372, 9967642, 4172405500,
      1081866279, 349768696},
     {3, 1, 0, 2, 150, 0, 1, 9},
     {396408665, 1258153403, 341621272, 627097509, 859328, 1698607573,
      171242357, 258766392}},
    {{1529552648, 3578004382, 1380553359, 571623609, 1085299154, 1357534021,
      158260936, 1195642468},
     {510815522, 1959054964, 1906964980, 1373316934, 1200827421, 1957046153,
      337903393, 1991021852},
     {2, 1, 0, 0, 0, 0, 0, 0},
     {507921604, 1618949418, 1380553359, 571623609, 1085299154, 1357534021,
      158260936, 1195642468}},
    {{994898185, 1135442551, 976180472, 1400804368, 866707530, 707736799,
      198393746, 1261075906},
     {4207689739, 1213892796, 1828145916, 1261303585, 2166168738, 3084795985,
      1705308305, 2402315203},
     {0, 0, 0, 1, 0, 0, 0, 0},
     {994898185, 1135442551, 976180472, 139500783, 866707530, 707736799,
      198393746, 1261075906}},
    {{4143098010, 1367685847, 3918136146, 1020032026, 4066888011, 1150064788,
      744721971, 4014300983},
     {1285548974, 599900577, 1984600644, 709591189, 2642763246, 1455925433,
      3727866066, 1353708945},
     {3, 2, 1, 1, 1, 0, 0, 2},
     {286451088, 167884693, 1933535502, 310440837, 1424124765, 1150064788,
      744721971, 1306883093}},
    {{953656480, 1410990963, 467191961, 93495459, 4088173918, 626237782,
      126129133, 3917992649},
     {1157919958, 1268206150, 1264402188, 4017441589, 1643624665, 912877091,
      1239444993, 1326721754},
     {0, 1, 0, 0, 2, 0, 0, 2},
     {953656480, 142784813, 467191961, 93495459, 800924588, 626237782,
      126129133, 1264549141}},
    {{403332341, 768201719, 543586514, 143270527, 1584668324, 522965783,
      835904258, 1285581191},
     {2268959277, 1734819722, 1394477978, 1506774134, 823266470, 1900871663,
      1071677479, 1575260392},
     {0, 0, 0, 0, 1, 0, 0, 0},
     {403332341, 768201719, 543586514, 143270527, 761401854, 522965783,
      835904258, 1285581191}},
    {{611115651, 867593495, 3729920259, 269144960, 4127780930, 1238864585,
      1153128116, 3884295560},
     {732594129, 1468417879, 196626094, 327726309, 711520702, 619151238,
      1024569669, 1877746451},
     {0, 0, 18, 0, 5, 2, 1, 2},
     {611115651, 867593495, 190650567, 269144960, 570177420, 562109, 128558447,
      128802658}},
    {{1031102250, 1203359879, 114767672, 180870776, 408145498, 4130907747,
      559125319, 625113566},
     {1271494678, 651794691, 804895187, 977248824, 724662778, 498299198,
      494822427, 587588323},
     {0, 1, 0, 0, 0, 8, 1, 1},
     {1031102250, 551565188, 114767672, 180870776, 408145498, 144514163,
      64302892, 37525243}},
    {{1395561930, 1184547065, 366393924, 416038713, 4000069127, 1049933010,
      1232242168, 1292028567},
     {498721857, 815643315, 3969353552, 277943189, 1334634754, 4178138550,
      55029349, 4277998913},
     {2, 1, 0, 1, 2, 0, 22, 0},
     {398118216, 368903750, 366393924, 138095524, 1330799619, 1049933010,
      21596490, 1292028567}},
};

int main() {
  const unsigned N = sizeof(tests) / sizeof(tests[0]);
  unsigned i;
  for (i = 0; i < N; ++i)
    if (test__udivmodv8si4(tests[i][0], tests[i][1], tests[i][2], tests[i][3]))
      return 1;

  return 0;
}
