// RUN: %clang_builtins %s %librt -o %t && %run %t
// REQUIRES: librt_has_modv4hi3

#include <stdio.h>

// Returns: a % b

typedef short v4hi __attribute__((__vector_size__(8)));
v4hi __modv4hi3(v4hi a, v4hi b);

int test__modv4hi3(v4hi a, v4hi b, v4hi expected_r) {
  v4hi r = __modv4hi3(a, b);
  int res = 0;
  for (int lane = 0; lane < 4; ++lane)
    if (r[lane] != expected_r[lane]) {
      printf("error in __modv4hi3 (lane %d): %X %% %X = %X, expected %X\n",
             lane, a[lane], b[lane], r[lane], expected_r[lane]);
      res = 1;
    }
  return res;
}

v4hi tests[][3] = {
    {{1, -1, 12, -101}, {10, 11, -11, -100}, {1, -1, 1, -1}},
    {{100, -100, 0, -90}, {101, 95, 1, -90}, {100, -5, 0, 0}},
    {{-6688, -11103, 6042, 16639},
     {16428, 8821, 19740, 194},
     {-6688, -2282, 6042, 149}},
    {{11567, 19804, 19176, 11613},
     {19345, -30957, 24501, 23331},
     {11567, 19804, 19176, 11613}},
    {{-30192, 7087, 17488, 21600},
     {22323, -21171, 22160, 14218},
     {-7869, 7087, 17488, 7382}},
    {{11656, 25303, 23512, 12582},
     {26646, -12644, 26986, 3009},
     {11656, 15, 23512, 546}},
    {{9069, -4956, 28724, -11782},
     {-16064, 13273, -19430, -10544},
     {9069, -4956, 9294, -1238}},
    {{27860, 12067, 2784, 10592},
     {-18890, 1617, -5419, -7110},
     {8970, 748, 2784, 3482}},
    {{32308, -10191, 23848, 12204},
     {-2331, 22330, -3005, 11133},
     {2005, -10191, 2813, 1071}},
    {{3750, 503, 26697, 12457},
     {15978, 26273, -463, -27972},
     {3750, 503, 306, 12457}},
    {{18930, 17827, 15200, -31706},
     {29202, -28465, 2564, -8731},
     {18930, 17827, 2380, -5513}},
    {{9849, 11647, 9209, 5010},
     {-19842, -2110, 26169, 9680},
     {9849, 1097, 9209, 5010}},
    {{7532, 21965, 3460, 20573},
     {-23322, 15438, -28004, 5398},
     {7532, 6527, 3460, 4379}},
};

int main() {
  const unsigned N = sizeof(tests) / sizeof(tests[0]);
  unsigned i;
  for (i = 0; i < N; i++)
    if (test__modv4hi3(tests[i][0], tests[i][1], tests[i][2]))
      return 1;

  return 0;
}
