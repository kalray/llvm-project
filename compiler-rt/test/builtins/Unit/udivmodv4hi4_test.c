// RUN: %clang_builtins %s %librt -o %t && %run %t
// REQUIRES: librt_has_udivmodv4hi4

#include <stdio.h>

// Returns: a / b, if (r) r = a % b

typedef unsigned short v4hu __attribute__((__vector_size__(8)));
v4hu __udivmodv4hi4(v4hu a, v4hu b, v4hu *r);

int test__udivmodv4hi4(v4hu a, v4hu b, v4hu expected_q, v4hu expected_rem) {
  v4hu rem;
  v4hu q = __udivmodv4hi4(a, b, &rem);
  int res = 0;
  for (int lane = 0; lane < 4; ++lane)
    if (q[lane] != expected_q[lane] || rem[lane] != expected_rem[lane]) {
      printf(
          "error in __udivmodv4hi4 (lane %d): %X divmod %X = q(%X), rem(%X), "
          "expected q(%X), rem (%X)\n",
          lane, a[lane], b[lane], q[lane], rem[lane], expected_q[lane],
          expected_rem[lane]);
      res = 1;
    }
  return res;
}

v4hu tests[][4] = {
    {{1, 1, 12, 101}, {10, 11, 11, 101}, {0, 0, 1, 1}, {1, 1, 1, 0}},
    {{1011, 9594, 0, 90}, {101, 95, 1, 90}, {10, 100, 0, 1}, {1, 94, 0, 0}},
    {{11195, 49144, 6315, 57045},
     {37834, 51498, 45363, 24168},
     {0, 0, 0, 2},
     {11195, 49144, 6315, 8709}},
    {{57271, 48829, 29231, 23183},
     {59200, 661, 32155, 59615},
     {0, 73, 0, 0},
     {57271, 576, 29231, 23183}},
    {{55379, 37807, 46892, 5439},
     {21607, 7781, 64962, 48786},
     {2, 4, 0, 0},
     {12165, 6683, 46892, 5439}},
    {{37264, 62856, 56865, 10694},
     {30220, 23745, 41916, 34007},
     {1, 2, 1, 0},
     {7044, 15366, 14949, 10694}},
    {{51738, 8365, 5388, 61644},
     {8720, 25472, 39995, 20834},
     {5, 0, 0, 2},
     {8138, 8365, 5388, 19976}},
    {{34694, 57464, 28220, 17297},
     {28689, 58832, 12425, 4970},
     {1, 0, 2, 3},
     {6005, 57464, 3370, 2387}},
    {{46215, 14328, 49926, 26984},
     {48525, 52872, 36296, 47438},
     {0, 0, 1, 0},
     {46215, 14328, 13630, 26984}},
    {{28579, 39865, 37785, 41458},
     {11049, 55762, 22693, 24411},
     {2, 0, 1, 1},
     {6481, 39865, 15092, 17047}},
    {{9463, 29273, 21272, 62428},
     {29954, 425, 21729, 14102},
     {0, 68, 0, 4},
     {9463, 373, 21272, 6020}},
    {{64526, 37814, 56747, 9826},
     {3508, 43052, 25457, 3069},
     {18, 0, 2, 3},
     {1382, 37814, 5833, 619}},
    {{63342, 51480, 52768, 37440},
     {19901, 35358, 43809, 29248},
     {3, 1, 1, 1},
     {3639, 16122, 8959, 8192}},
};

int main() {
  const unsigned N = sizeof(tests) / sizeof(tests[0]);
  unsigned i;
  for (i = 0; i < N; ++i)
    if (test__udivmodv4hi4(tests[i][0], tests[i][1], tests[i][2], tests[i][3]))
      return 1;

  return 0;
}
