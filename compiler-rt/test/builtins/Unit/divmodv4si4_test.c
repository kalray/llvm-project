// RUN: %clang_builtins %s %librt -o %t && %run %t
// REQUIRES: librt_has_divmodv4si4

#include <stdio.h>

// Returns: a / b, if (r) r = a % b

typedef int v4si __attribute__((__vector_size__(16)));
v4si __divmodv4si4(v4si a, v4si b, v4si *r);

int test__divmodv4si4(v4si a, v4si b, v4si expected_q, v4si expected_rem) {
  v4si rem;
  v4si q = __divmodv4si4(a, b, &rem);
  int res = 0;
  for (int lane = 0; lane < 4; ++lane)
    if (q[lane] != expected_q[lane] || rem[lane] != expected_rem[lane]) {
      printf("error in __divmodv4si4 (lane %d): %X divmod %X = q(%X), rem(%X), "
             "expected q(%X), rem (%X)\n",
             lane, a[lane], b[lane], q[lane], rem[lane], expected_q[lane],
             expected_rem[lane]);
      res = 1;
    }
  return res;
}

v4si tests[][4] = {
    {{1, -1, 12, -101}, {10, 11, -11, -100}, {0, 0, -1, 1}, {1, -1, 1, -1}},
    {{1015, -9594, 0, -90}, {101, 95, 1, 90}, {10, -100, 0, -1}, {5, -94, 0, 0}},

    {{-438350705, -727698365, 396004311, 1090515857},
     {1076654945, 578063530, 1293662685, 12667576},
     {0, -1, 0, 86},
     {-438350705, -149634835, 396004311, 1104321}},

    {{1196451266, 1447482300, 860822516, 751371840},
     {-247112566, 1538554332, 708094629, 1517514300},
     {-4, 0, 1, 0},
     {208001002, 1447482300, 152727887, 751371840}},

    {{1558326566, -833471307, -110660989, 654583242},
     {403226963, 2088846169, -712705, 154091689},
     {3, 0, 155, 4},
     {348645677, -833471307, -191714, 38216486}},

    {{1279633387, 1193866625, 394812222, 340801848},
     {631985730, -274593459, 316140686, -696407124},
     {2, -4, 1, 0},
     {15661927, 95492789, 78671536, 340801848}},

    {{-169579339, -325789548, 341621268, -808015043},
     {1511667555, 1794100362, 1331780161, -547480793},
     {0, 0, 0, 1},
     {-169579339, -325789548, 341621268, -260534250}},

    {{1231562698, 1115699311, -426683109, 775344130},
     {-354837663, -1089715213, 1259932727, -35441438},
     {-3, -1, 0, -21},
     {167049709, 25984098, -426683109, 31073932}},

    {{1529552642, -716962916, 1380553359, 571623586},
     {1252348713, 1383518119, -268422174, 1226716391},
     {1, 0, -5, 0},
     {277203929, -716962916, 38442489, 571623586}},

    {{114406858, 700901561, 1565343703, 746219425},
     {1477172022, -458524336, 205103525, -1991088250},
     {0, -1, 7, 0},
     {114406858, 242377225, 129619028, 746219425}},

    {{994898183, 1135442549, 976180479, 1400804368},
     {981114388, 950114024, 328012774, 2007295331},
     {1, 1, 2, 0},
     {13783795, 185328525, 320154931, 1400804368}},

    {{-595199160, -405056621, 447592559, 689679976},
     {1094653379, 1912590489, 1867202300, -1687490193},
     {0, 0, 0, 0},
     {-595199160, -405056621, 447592559, 689679976}},

    {{-151869286, 1367685847, -376831150, 1020032025},
     {-823278445, 745008167, 1192314530, 409013663},
     {0, 1, 0, 2},
     {-151869286, 622677680, -376831150, 202004699}},
};

int main() {
  const unsigned N = sizeof(tests) / sizeof(tests[0]);
  unsigned i;
  for (i = 0; i < N; ++i)
    if (test__divmodv4si4(tests[i][0], tests[i][1], tests[i][2], tests[i][3]))
      return 1;

  return 0;
}
